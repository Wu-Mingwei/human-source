---
title: "Human Sources analysis"
author: "Mingwei (Show) Wu"
output: pdf_document
---
## Background 
### "Turnover" : turnover is that churn refers to the gradual loss of employees over a period of time. In a company, the employee turnover is the biggest issue facing HR and high costs Therefore, analysis the employee turnover is the way to prevent the damange and save mony to company. Usually, the comon reasons employee turnover is better opportunity, healh, rolocation, eaducation, and personal reasons etc.In addition, some hidden reasons of employees turnover includes percent salary hike, overtime, travel distance, career satisfaction, tenure, and supervisor's personality etc.

## Data
### emp_id: employees id
### status: working status, Active and Inactive
### location: location of working city
### level: Job level in Company
### gender: Male and Female
### emp_age: employees age
### rating: Internal work evaluation level
### mar_rating: employees' manager internal work evaluation level
### mgr_reportees: employees' manager report
### mgr_age: employees' manager age
### mgr_tenure: employees' manager tenure
### compensation: salary
### percent_hike: precentage of increase salary
### hiring_score: hire interview score
### hiring_sourece: platform for job
### no_previous_companies_worked: number of previous work rompaneies
### distance_from_homne: distance between home and work place
### total_dependets: number of dependets
### marital_status: status of marry
### education: education level
### promotion_last_2_years: the promotion of employee within last 2 years
### no_leaves_taken: number of leaves have been taken
### total_experience: total of work experience
### monthly_overtime_hrs: total number of monthly overtime hours
### date_of_joining: date of join the companey
### last_working_date: last working date before leaf
### department: company department
### mgr_id: manager id
### cutoff_date: data cut-off date in database
### turnover: 0 is stay, 1 is leaf
### mgr_effectiveness: manager effectiveness
### career_satisfaction: percentage of career satisfaction
### perf_satisfaction: percentage of performance satisfaction
### work_satisfaction: percentage of performance satisfaction

##Purpose
### Analysis employees turnover is the way to prevent the damage, save cost, increase efficiency, and building up company culture. It is huge part of challenge to HR. Our goal is to provide the insights and actionable tips to prevent the employees turnover. Focus on what reason for our employees leaving and how to raise their satification, operation as well as increase the ROI. Reducing risk cost and increase profit in hidden part.
##Method
## Question 1: How many employees status were change on the cut-off data (12/31/2014). Which is highest risk level for employee turnover? Track the key metrics to provide the overview.
### For the question, use the MySQL to select the dataset or use R to import the data for manipulation. Counting the status then use R to filter the highest proportion level to track. Also, check the significant factors for reason of turnover.

## Data Importing
###Importing the original data of organization, deal with 1954 observations and 34 column.
```{r echo=FALSE}
library(readr)
library(dplyr)
library(tidyverse)
org<-read.csv("org_final.csv")
dim(org)
```
```{r echo=FALSE}
dim(org)
```
# Fomular for turnover rate
##Turnover rate = Number of employees who left / Total number of employees
### counting the status from data frame. we know the active employee is 1557, and 397 employees left the company.
```{r echo=FALSE}
org%>%
  count(status) # see how many employees still be active
```
### calculate a mean of turnover_rate. the rate is approximation 18% for employees left
```{r echo=FALSE}
org%>%
  summarise(turnover_rate=mean(turnover)) # Since 1 is inactive employee, so the rate is approximation 18% employees who left.
```

### Approximation 22% of Analyst job level leaving and 15% of Specialist level leaving end of 12/31/2014 in the company.
```{r echo=FALSE}
level<- org%>% #checking the rate of turnover between different level
  group_by(level)%>%
  summarise(turnover_rate=mean(turnover))  
level
```

### use graph for data visulization. the graph is showing the rate value between the analyst level and spcialist level.
```{r echo=FALSE}
library(ggplot2) #plot the histogram to see the turnover_rate of level
library(scales)
library(broom)
level%>%
  ggplot(aes(level, turnover_rate))+geom_col()+scale_y_continuous(limits = c(0,0.5),
                                                                  labels = percent)
```
## Question: calculate the turnover rate in different cites
### Company has 3 controlled company in Chicago, New York, Orlando. After calculating the trunover_rate, we can see the highest proportion is in New York city, and the lowest is Orlando.
```{r echo=FALSE}
location<- org%>%  # checking the turnover_rate of location
  group_by(location)%>%
  summarise(turnover_rate=mean(turnover)) ;  location
```
```{r}
location%>%  #histogram to data visulization
  ggplot(aes(location,turnover_rate))+ geom_col()
```

## chekcing rating relationship for turnover_rate
### from the data calculating, the internal work evulation rate are showing that the unacceptable is 63% highest proportion of turnover_rate. The number 2 higher proportion is below average rating. On the contraction, the acceptable is 22%, above average 13% and excellent only 3%
```{r echo=FALSE}
org%>%   # calculate the turnover_rate in rating
  group_by(rating)%>%
  summarise(turnover_rate=mean(turnover))
```
##Question: is the work evulation as main factor for employee turnover? the employee was fire by company? 
###the grph showing manager effectiveness also affct the employee turnover. the box-plot shows the outliers of inactive. however, overall shows that the mean of manger effectiveness of active is higher than inactive. according to box-plot, we know the manger effectiveness also affect turnover of employees.
```{r echo=FALSE}
org%>%
  ggplot(aes(status,mgr_effectiveness))+geom_boxplot() #graph to show if the effectiveness relationship with status
```
### checking the distance between work place and home either effect to turnover or not.
```{r echo=FALSE}
org%>%
  ggplot(aes(status, distance_from_home))+geom_boxplot() # graph for the relationship between distance from home with status
```

# Job-hop Index = Total experience / Number of companies

```{r}
emp_age_diff<-org%>%
  mutate(age_diff= mgr_age-emp_age)
emp_age_diff%>%
  ggplot(aes(status,age_diff))+geom_boxplot()
```
```{r}
glimpse(emp_age_diff)
```

```{r}
emp_JHI<-emp_age_diff%>%
  mutate(jhi=total_experience / no_previous_companies_worked) #calcultate the Job hop for each emplyees from age different
emp_JHI%>%
  ggplot(aes(status,jhi))+geom_boxplot() # box-plot to demonstrate the outliers and mean
```

```{r}
library(lubridate) #load package for manipulation the time
```
```{r}
emp_tenure<- emp_JHI%>%
  mutate(tenure = ifelse(status=="Active",
         time_length(interval(date_of_joining, cutoff_date), "years"),
         time_length(interval(date_of_joining, last_working_date), "years"))) #add column for work duration of employee
emp_tenure%>%
  ggplot(aes(status,tenure))+geom_boxplot() #box plot displaying
```

```{r}
emp_tenure%>%
  ggplot(aes(compensation))+geom_histogram() #plot the distribution for compensation
```
```{r}
emp_tenure%>%
  ggplot(aes(level, compensation, fill=status))+geom_boxplot() # graph to compare the compensation within status 
```
# Compa Ratio is estimation to evaluate the employee wage percentage to median pay.
##Compa Ratio = Actual Compensation / Median Compensation 
```{r}
emp_ratio<- emp_tenure%>%
  group_by(level)%>%
  mutate(median_compensation = median(compensation),
         compa_ratio = (compensation / median_compensation)) # derive compensation ratio
emp_ratio%>%
  distinct(level,median_compensation) # look at the median compensation for each level
```
```{r}
emp_final<- emp_ratio%>%
  mutate(emp_level = ifelse( compa_ratio > 1, "Above", "Below")) # add compa level , if compa_ration geater than 1 meaning above, else meaning below
emp_final%>%
  ggplot(aes(status, fill = emp_level))+geom_bar(position = "fill") #compare compa level between active and inactive
```

# Unstanding information value : measure of predictive power of independent variable to accurately predict the dependent variable
## Information value = sima(% of non-events-% of events))* log( % of non-events/% of events)
##information value : less than 0.15 meaning predictive power is poor, if 0.15 < IV < 0.4 id moderate, else greater than 0.4 meaning strong.
```{r}
library(Information)
IV <- create_infotables(data = emp_final, y = "turnover") 
IV$Summary  #after we calculate the information value, we can see which variables are significant stronger for predictive power
```
# split the data 70% into train and 30% into test 
```{r}
library(ISLR)
smp_siz <- floor(0.7 * nrow(emp_final) )
smp_siz
```
```{r}
set.seed(1234)
train_ind<-sample(seq_len(nrow(emp_final)), size = smp_siz)
train <- emp_final [train_ind,]
test<- emp_final [-train_ind,]
```

```{r}
train%>%
  count(status)%>%
  mutate(prop=n/sum(n)) #calculate the proportion in train for level and status
```
```{r}
test%>%
  count(status)%>%
  mutate(prop=n/sum(n)) # calculate the proportion in test for level and status
```
```{r}
log<- glm(turnover ~ percent_hike,
          family= "binomial",
          data=train) # build a logistic regression using percent_hike to predict turnover
summary(log)
```
```{r}
mul_log<- glm(turnover~ level+gender+mgr_rating+compensation+hiring_score+marital_status+distance_from_home+monthly_overtime_hrs+work_satisfaction,
              family="binomial",
              data=train) #bulid a multiple regression model for couple independent variables to predict turnover
summary(mul_log)
```

```{r}
mul_log1<- glm(turnover~ level+compensation+distance_from_home+monthly_overtime_hrs+work_satisfaction,
               family="binomial",
               data=train)
summary(mul_log1)
```
#Variance Inflation Factor
```{r}
library(car)
vif(mul_log1) #check a multicollinearity, the vif for each variables is greater than 1 but less than 2. they are showing the indepent variables moderately correlated
```

```{r}
prediction_train<- predict(mul_log1, newdata= train,
                           type = "response")
hist(prediction_train) # distribution skewed left, and histogram shown the probability to the employees who will left organization
```

```{r}
prediction_test<-predict(mul_log1 , newdata = test,
                         type = "response")
hist(prediction_test) # check a train data into test data
```

# Turn probabilities in categories by using a cut-off
```{r}
pre_cut <- ifelse(prediction_test >0.5 , 1 ,0) #classify predictions using a cut-off of 0.5
conf_matrix<- table(pre_cut , test$turnover)
conf_matrix # 1 means inactive while 0 is active
```

```{r}
n<-sum(conf_matrix) #number of instances
nc<- nrow(conf_matrix) # number of classes
diag <- diag(conf_matrix) # number of correctly classified instances per class 
rowsums <- apply(conf_matrix, 1, sum) # number of instances per class
colsums <- apply(conf_matrix, 2, sum) # number of predictions per class
p <- rowsums / n # distribution of instances over the actual classes
q <- colsums / n # distribution of instances over the predicted classes
```

```{r}
accuracy <- sum(diag) / n ; accuracy # the model's accuracy is 0.88
precision <- diag/colsums;precision # the model's precision to active is 0.97 and inactive 0.53
```

#create retension strategy

```{r}
library(tidypredict)
emp_risk<- emp_final %>%
  filter (status == "Active")%>%
  tidypredict_to_column(mul_log1) # calculate probability of turnover and add predictions using the mul_log model
```

```{r}
emp_risk %>%
  select(emp_id , fit)%>%
  group_by(level)%>%
  top_n(5, wt = fit)%>%
  arrange(desc(fit))  # look at the employee's probability of turnover from high to low 
```

```{r}
emp_risk_bucket <- emp_risk%>%
  mutate(risk_bucket =cut(fit, breaks =c(0,0.3,0.5,0.7,1),
                            labels = c("no-risk", "low-risk", "medium-risk", "high-risk")))
emp_risk_bucket%>%
  count(risk_bucket)%>% #calculate the risk of turnover to the active employee
  group_by(risk_bucket)
```

#ROI: retun on investment
##ROI = Program Benifits / Program Cost
```{r}
emp_final%>%
  ggplot(aes(percent_hike))+geom_histogram(binwidth = 3) #plot histogram of percent hike
```
```{r}
emp_hike_range<- emp_final%>%
  filter(level == "Analyst")%>%
  mutate(hike_rage = cut(percent_hike, breaks = c(0,10,15,20),
                         include.lowest = TRUE,
                         labels = c("0-10","11-15","16-20"))) #create salary hike_rage of analyst level employees
df_hike<-emp_hike_range%>%
  group_by(hike_rage)%>%
  summarise(turnover_rate_hike = mean(turnover)) # calculate the turnover rate for each salary hike rage
```
```{r}
df_hike%>%
  ggplot(aes(hike_rage, turnover_rate_hike))+geom_col()
```

```{r}
emp_final%>%
  filter(level == "Analyst")%>%
  count(median_compensation) # after filter we know median_compensation of analyst is 51840
```
```{r}
emp_final%>%
  filter(level=="Analyst")%>%
  select(compensation)%>%
  arrange(compensation)%>%
  head()#calculate the minium salary to analyst
```

```{r}
extra_cost<- 51840 * 0.05 ; extra_cost #increase the salary 5%
savings <- 40000*0.17 ; savings #assuming the analyst left then hire other one and traning cost
```

```{r}
ROI<-(savings / extra_cost)*100
cat(paste0("The return on investment is ", round(ROI), "%!"))
```